<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>고급 유튜브 분석기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
        }
        .card {
            background-color: #2d3748;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center">

<div class="container bg-gray-800 rounded-xl shadow-lg p-8">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold mb-2">고급 유튜브 분석기</h1>
        <p class="text-gray-400">API 키, 지역, 카테고리, 그리고 표시할 영상 수를 설정하여 인기 채널을 분석합니다.</p>
        <p class="text-xs text-yellow-400 mt-2">
            ※ 참고: API 제약으로 인해 '최근 며칠간 분석' 기능은 지원되지 않습니다.
        </p>
    </div>

    <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-8">
        <input type="text" id="apiKeyInput" class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="여기에 YouTube API 키를 입력하세요.">
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div>
            <label for="regionSelect" class="block text-sm font-medium mb-1">지역</label>
            <select id="regionSelect" class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="KR">대한민국</option>
                <option value="US">미국</option>
                <option value="JP">일본</option>
                <option value="GB">영국</option>
                <option value="DE">독일</option>
            </select>
        </div>
        <div>
            <label for="categorySelect" class="block text-sm font-medium mb-1">카테고리</label>
            <select id="categorySelect" class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">전체 카테고리</option>
                <option value="1">영화 & 애니메이션</option>
                <option value="2">자동차</option>
                <option value="10">음악</option>
                <option value="17">스포츠</option>
                <option value="19">여행 & 이벤트</option>
                <option value="20">게임</option>
                <option value="22">피플 & 블로그</option>
                <option value="23">코미디</option>
                <option value="24">엔터테인먼트</option>
                <option value="25">뉴스 & 정치</option>
                <option value="26">하우투 & 스타일</option>
                <option value="27">교육</option>
                <option value="28">과학 기술</option>
            </select>
        </div>
        <div>
            <label for="videoCountInput" class="block text-sm font-medium mb-1">표시할 영상 수</label>
            <input type="number" id="videoCountInput" class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="10" min="1" max="50">
        </div>
        <div>
            <label for="maxSubsInput" class="block text-sm font-medium mb-1">최대 구독자 수</label>
            <input type="number" id="maxSubsInput" class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="예: 30000" value="">
        </div>
    </div>

    <button id="analyzeButton" class="w-full px-6 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors duration-300 font-bold mb-8">분석하기</button>

    <div id="loading" class="hidden flex justify-center items-center py-8">
        <div class="loading-spinner"></div>
    </div>
    
    <div id="errorMessage" class="hidden bg-red-800 text-red-100 p-4 rounded-lg text-center mb-8"></div>

    <div id="results" class="hidden">
        <div id="videoList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
</div>

<script>
  const apiKeyInput = document.getElementById('apiKeyInput');
  const regionSelect = document.getElementById('regionSelect');
  const categorySelect = document.getElementById('categorySelect');
  const videoCountInput = document.getElementById('videoCountInput');
  const maxSubsInput = document.getElementById('maxSubsInput');
  const videoTypeSelect = document.getElementById('videoTypeSelect');
  const analyzeButton = document.getElementById('analyzeButton');
  const loadingDiv = document.getElementById('loading');
  const errorMessageDiv = document.getElementById('errorMessage');
  const resultsDiv = document.getElementById('results');
  const videoListDiv = document.getElementById('videoList');

  // ISO8601 → seconds
  function parseISO8601Duration(duration) {
    const m = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+(?:\.\d+)?)S)?/);
    if (!m) return 0;
    const h = parseInt(m[1] || 0, 10);
    const mi = parseInt(m[2] || 0, 10);
    const s = parseFloat(m[3] || 0);
    return h * 3600 + mi * 60 + s;
  }
  function formatDuration(sec) {
    sec = Math.floor(sec);
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    const mm = m < 10 ? '0' + m : m;
    const ss = s < 10 ? '0' + s : s;
    return h > 0 ? `${h}:${mm}:${ss}` : `${mm}:${ss}`;
  }
  function showError(msg) {
    errorMessageDiv.textContent = msg;
    errorMessageDiv.classList.remove('hidden');
  }
  function nf(n) { return Number(n || 0).toLocaleString('ko-KR'); }

  async function fetchJSON(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  async function collectRecentVideoIds(API_KEY, regionCode, days, maxCollect = 200) {
    const publishedAfter = new Date(Date.now() - days * 86400000).toISOString();
    let ids = [];
    let pageToken = '';
    while (ids.length < maxCollect) {
      const params = new URLSearchParams({
        part: 'id',
        type: 'video',
        order: 'date',
        publishedAfter,
        regionCode,
        maxResults: '50',
        key: API_KEY,
      });
      if (pageToken) params.set('pageToken', pageToken);
      const data = await fetchJSON(`https://www.googleapis.com/youtube/v3/search?${params}`);
      ids.push(...(data.items || []).map(it => it.id.videoId));
      pageToken = data.nextPageToken || '';
      if (!pageToken) break;
    }
    return ids;
  }

  async function chunkedFetchVideosDetails(API_KEY, ids) {
    const out = [];
    for (let i = 0; i < ids.length; i += 50) {
      const chunk = ids.slice(i, i + 50);
      const params = new URLSearchParams({
        part: 'snippet,statistics,contentDetails',
        id: chunk.join(','),
        key: API_KEY
      });
      const data = await fetchJSON(`https://www.googleapis.com/youtube/v3/videos?${params}`);
      out.push(...(data.items || []));
    }
    return out;
  }

  async function fetchChannelsSubs(API_KEY, channelIds) {
    const subs = new Map();
    const unique = [...new Set(channelIds)];
    for (let i = 0; i < unique.length; i += 50) {
      const chunk = unique.slice(i, i + 50);
      const params = new URLSearchParams({
        part: 'statistics,snippet',
        id: chunk.join(','),
        key: API_KEY
      });
      const data = await fetchJSON(`https://www.googleapis.com/youtube/v3/channels?${params}`);
      (data.items || []).forEach(ch => {
        subs.set(ch.id, parseInt(ch.statistics?.subscriberCount || 0, 10));
      });
    }
    return subs;
  }

  analyzeButton.addEventListener('click', async () => {
    const API_KEY = apiKeyInput.value.trim();
    const regionCode = regionSelect.value;
    const categoryId = (categorySelect.value || '').trim(); // filter later
    const topK = Math.min(Math.max(parseInt(videoCountInput.value || 30, 10), 1), 50);
    const maxSubs = maxSubsInput.value.trim() ? parseInt(maxSubsInput.value, 10) : null;
    const videoType = videoTypeSelect.value; // all | long | short

    if (!API_KEY) return showError('API 키를 입력해주세요.');

    loadingDiv.classList.remove('hidden');
    resultsDiv.classList.add('hidden');
    errorMessageDiv.classList.add('hidden');
    videoListDiv.innerHTML = '';

    try {
      // 1) 최근 5일 업로드 수집
      const ids = await collectRecentVideoIds(API_KEY, regionCode, 5, 200);
      if (ids.length === 0) return showError('최근 5일 내 업로드된 영상을 찾지 못했습니다.');

      // 2) 상세(통계/길이/카테고리) 조회
      let videos = await chunkedFetchVideosDetails(API_KEY, ids);

      // 3) 카테고리 필터(선택)
      if (categoryId) {
        videos = videos.filter(v => v.snippet?.categoryId === categoryId);
      }

      // 4) 채널 구독자수 조회
      const channelIds = videos.map(v => v.snippet?.channelId).filter(Boolean);
      const subsMap = await fetchChannelsSubs(API_KEY, channelIds);

      // 5) 타입/구독자수 필터
      videos = videos.filter(v => {
        const dur = parseISO8601Duration(v.contentDetails?.duration || 'PT0S');
        if (videoType === 'short' && dur >= 60) return false;
        if (videoType === 'long' && dur < 60) return false;
        const subs = subsMap.get(v.snippet.channelId) || 0;
        if (maxSubs !== null && subs > maxSubs) return false;
        return true;
      });

      if (videos.length === 0) return showError('필터 조건에 맞는 영상이 없습니다.');

      // 6) 조회수 기준 정렬 후 상위 N
      videos.sort((a, b) => (Number(b.statistics?.viewCount || 0) - Number(a.statistics?.viewCount || 0)));
      const top = videos.slice(0, topK);

      // 7) 렌더링
      top.forEach((v, idx) => {
        const durSec = parseISO8601Duration(v.contentDetails?.duration || 'PT0S');
        const subs = subsMap.get(v.snippet.channelId) || 0;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <a href="https://www.youtube.com/watch?v=${v.id}" target="_blank" rel="noopener noreferrer">
            <img src="${v.snippet?.thumbnails?.high?.url || ''}" alt="${v.snippet?.title || ''}" class="rounded-lg w-full mb-4">
          </a>
          <div class="text-xs text-gray-400 mb-1">#${idx+1}</div>
          <div class="text-sm text-gray-400">
            <p class="mb-1"><strong>채널:</strong> <span class="text-blue-300 font-bold">${v.snippet?.channelTitle || '알 수 없음'}</span></p>
            <p class="mb-1"><strong>구독자 수:</strong> ${nf(subs)}명</p>
          </div>
          <h3 class="text-lg font-bold text-blue-300 hover:underline mt-2">${v.snippet?.title || ''}</h3>
          <div class="text-sm text-gray-400 mt-2">
            <p class="mb-1"><strong>조회수:</strong> ${nf(v.statistics?.viewCount)}회</p>
            <p class="mb-1"><strong>좋아요:</strong> ${nf(v.statistics?.likeCount)}개</p>
            <p class="mb-1"><strong>댓글 수:</strong> ${nf(v.statistics?.commentCount)}개</p>
            <p class="mb-1"><strong>영상 길이:</strong> ${formatDuration(durSec)}</p>
            <p class="mb-1"><strong>업로드:</strong> ${new Date(v.snippet?.publishedAt).toLocaleString('ko-KR')}</p>
          </div>
        `;
        videoListDiv.appendChild(card);
      });

      resultsDiv.classList.remove('hidden');
    } catch (e) {
      console.error(e);
      showError('데이터 수집 중 오류가 발생했습니다. (키/쿼터/네트워크 확인)');
    } finally {
      loadingDiv.classList.add('hidden');
    }
  });
</script>

</body>
</html>
